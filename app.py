from flask import Flask, render_template, request, jsonify
import requests
import os


app = Flask(__name__)
chat_history = []

# ๐ ุงูููุชุงุญ ููุถุน ููุง ูุจุงุดุฑุฉ
API_KEY = f"Bearer {os.getenv('DEEPSEEK_API_KEY')}" 

def ask_deepseek(prompt):
    full_prompt = (
        "ุฃูุช ูุณุงุนุฏ ุฐูู ูุชุฎุตุต ูู ุชุนููู ูุบุฉ ุงูุฅุดุงุฑุฉ ููุตู ูุงูุจููุ ูุชููู ุงูุฏุงุฑุฌุฉ ุงูุฌุฒุงุฆุฑูุฉ ุฌูุฏุงู. "
        "ูุฌุจ ุฃู ุชููู ุฅุฌุงุจุงุชู ุฏูููุฉุ ูุฎุชุตุฑุฉุ ูุนูููุฉุ ูุชุฑูุฒ ุนูู ูู ูุง ูุฎุต ุงูุตู ูุงูุจูู: "
        "ุชุนููู ูุบุฉ ุงูุฅุดุงุฑุฉ ุงูุฌุฒุงุฆุฑูุฉ ูุงูุนุงูููุฉุ ุทุฑู ุงูุชูุงุตูุ ูุตุงุฆุญ ููุฃูู ูุงููุนููููุ ุญููู ุงูุตู ูุงูุจููุ "
        "ุงูุชูููุงุช ุงููุณุงุนุฏุฉุ ุงูุซูุงูุฉ ุงููุฌุชูุนูุฉุ ููู ูุง ูุชุนูู ุจุชุณููู ุญูุงุฉ ุงูุตู ูุงูุจูู ูู ุงูุฌุฒุงุฆุฑ ูุงูุนุงูู ุงูุนุฑุจู. "
        "ุงููู ุฃุณุฆูุฉ ุงููุณุชุฎุฏููู ูููุง ูุงูุช ุจุงูููุฌุฉ ุงูุฌุฒุงุฆุฑูุฉ ุฃู ุงูุนุฑุจูุฉ ุงููุตุญู ุฃู ุญุชู ุงููุฑูุณูุฉ ุงูุจุณูุทุฉุ "
        "ูุงุดุฑุญ ุฏุงุฆูุงู ุจุงูุนุฑุจูุฉ ุงููุตุญู ุงููุจุณุทุฉุ ูููููู ุชูุถูุญ ุงููุตุทูุญุงุช ุจุงูููุฌุฉ ุงูุฌุฒุงุฆุฑูุฉ ุนูุฏ ุงูุญุงุฌุฉ. "
        "ุฅุฐุง ูุงู ุงูุณุคุงู ุนู ูุบุฉ ุงูุฅุดุงุฑุฉ ุงูุฌุฒุงุฆุฑูุฉ ุฃู ุงูุฏุงุฑุฌุฉ ุงูุฌุฒุงุฆุฑูุฉุ ูุถูุญ ุงูุฃูุซูุฉ ุจุงูููุฌุฉ ุงูุฌุฒุงุฆุฑูุฉ. "
        "ุงุจุฏุฃ ุฏุงุฆูุงู ุฅุฌุงุจุชู ุจุงูุชุญูุฉ ุงูููุงุณุจุฉ (ูุซูุงู: ุงูุณูุงู ุนูููู). "
        "ุงุฎุชุตุฑ ุงูุฅุฌุงุจุฉ ูุฏุฑ ุงูุฅููุงู ููุฏู ููุท ุงููุนูููุงุช ุงููููุฏุฉ ูุงูุฌููุฑูุฉ ุฏูู ุฅุทุงูุฉ ุฃู ุชูุฑุงุฑ. "
        "ุฑุชุจ ุฅุฌุงุจุชู ุจุดูู ููุธู ููุงุถุญุ ูููุถู ุงุณุชุฎุฏุงู ุงูุชุนุฏุงุฏ ุฃู ุงูููุฑุงุช ุนูุฏ ุงูุญุงุฌุฉ. "
        "ุฅุฐุง ูุงู ุงูุณุคุงู ุบูุฑ ูุงุถุญุ ุงุทูุจ ุชูุถูุญุงู. "
        "ููู ุฌุฏุงู: ูุง ุชุถุน ุฃู ุฑููุฒ ุฃู ุฅูููุฌู ุฃู ุนูุงูุงุช ุฒุฎุฑููุฉ ูู ุงูุฑุฏ. "
        "ุฅุฐุง ุงุญุชุฌุช ูุนุฑุถ ูุงุฆูุฉ ุฃู ุดุฑุญ ุฎุทูุงุชุ ุงุณุชุฎุฏู ููุท ููุงุท ูุฑุชุจุฉ ุชุญุช ุจุนุถูุง ููุฐุง:\n"
        "โข ุงูููุทุฉ ุงูุฃููู\nโข ุงูููุทุฉ ุงูุซุงููุฉ\nโข ...ุงูุฎ\n"
        f"ุงูุณุคุงู: {prompt.strip()}"
    )

    try:
        headers = {
            "Content-Type": "application/json",
            "Authorization": API_KEY
        }

        data = {
            "model": "deepseek/deepseek-r1-0528:free",
            "messages": [
                {
                    "role": "system",
                    "content": (
                        "ุฃูุช ูุณุงุนุฏ ุฐูู ูุชุฎุตุต ูู ูู ูุง ูุฎุต ุงูุตู ูุงูุจูู ูู ุงูุฌุฒุงุฆุฑ ูุงูุนุงูู ุงูุนุฑุจู. "
                        "ูุฌุจ ุฃู ุชููู ุงูุฏุงุฑุฌุฉ ุงูุฌุฒุงุฆุฑูุฉ ุฌูุฏุงู ูุชุดุฑุญ ุฏุงุฆูุงู ุจุงูุนุฑุจูุฉ ุงููุตุญู ุงููุจุณุทุฉุ "
                        "ูุน ุชูุถูุญ ุงููุตุทูุญุงุช ุจุงูููุฌุฉ ุงูุฌุฒุงุฆุฑูุฉ ุนูุฏ ุงูุญุงุฌุฉ. "
                        "ุฑูุฒ ุนูู ุชุนููู ูุบุฉ ุงูุฅุดุงุฑุฉ ุงูุฌุฒุงุฆุฑูุฉ ูุงูุนุงูููุฉุ ูุตุงุฆุญ ุงูุชูุงุตูุ ุญููู ุงูุตู ูุงูุจููุ "
                        "ุงูุชูููุงุช ุงููุณุงุนุฏุฉุ ุงูุซูุงูุฉ ุงููุฌุชูุนูุฉุ ููู ูุง ูุณูู ุญูุงุฉ ุงูุตู ูุงูุจูู. "
                        "ุงุจุฏุฃ ุฏุงุฆูุงู ุฅุฌุงุจุชู ุจุงูุชุญูุฉ ุงูููุงุณุจุฉ (ูุซูุงู: ุงูุณูุงู ุนูููู). "
                        "ุงุฎุชุตุฑ ุงูุฅุฌุงุจุฉ ูุฏุฑ ุงูุฅููุงู ููุฏู ููุท ุงููุนูููุงุช ุงููููุฏุฉ ูุงูุฌููุฑูุฉ ุฏูู ุฅุทุงูุฉ ุฃู ุชูุฑุงุฑ. "
                        "ุฑุชุจ ุฅุฌุงุจุชู ุจุดูู ููุธู ููุงุถุญุ ูููุถู ุงุณุชุฎุฏุงู ุงูุชุนุฏุงุฏ ุฃู ุงูููุฑุงุช ุนูุฏ ุงูุญุงุฌุฉ. "
                        "ููู ุฌุฏุงู: ูุง ุชุถุน ุฃู ุฑููุฒ ุฃู ุฅูููุฌู ุฃู ุนูุงูุงุช ุฒุฎุฑููุฉ ูู ุงูุฑุฏ. "
                        "ุฅุฐุง ุงุญุชุฌุช ูุนุฑุถ ูุงุฆูุฉ ุฃู ุดุฑุญ ุฎุทูุงุชุ ุงุณุชุฎุฏู ููุท ููุงุท ูุฑุชุจุฉ ุชุญุช ุจุนุถูุง ููุฐุง:\n"
                        "โข ุงูููุทุฉ ุงูุฃููู\nโข ุงูููุทุฉ ุงูุซุงููุฉ\nโข ...ุงูุฎ\n"
                    )
                },
                *chat_history,
                {"role": "user", "content": full_prompt}
            ]
        }

        response = requests.post("https://openrouter.ai/api/v1/chat/completions", headers=headers, json=data)
        response.raise_for_status()
        result = response.json()

        reply = result["choices"][0]["message"]["content"]
        return reply

    except Exception as e:
        print("โ ูุดู ุงูุงุชุตุงู ุจู OpenRouter:", e)
        return "ุชุนุฐุฑ ุงูุงุชุตุงู ุจู DeepSeek. ุชุญูู ูู ุงูุงุชุตุงู ุฃู ููุชุงุญ API."

@app.route("/", methods=["GET", "POST"])
def index():
    if request.method == "POST":
        user_input = request.form["user_input"].strip()
        if user_input:
            chat_history.append({"role": "user", "content": user_input})
            reply = ask_deepseek(user_input)
            chat_history.append({"role": "assistant", "content": reply})
            # ุฅุฐุง ูุงู ุงูุทูุจ AJAX ุฃุฑุฌุน JSON ููุท
            if request.headers.get("Accept") == "application/json":
                return jsonify(reply=reply)
    if not chat_history:
        chat_history.append({
            "role": "assistant",
            "content": "ูุฑุญุจุงู! ุฃูุง ูุณุงุนุฏู ุงูุฐูู ูุชุนูู ูุบุฉ ุงูุฅุดุงุฑุฉ. ููู ูููููู ูุณุงุนุฏุชู ุงููููุ"
        })
    return render_template("index.html", messages=chat_history)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000, debug=True)

